<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundVerso - Histórico de Saídas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===================================================================
           1. Variáveis Globais e Reset (Padrão FundVerso)
           =================================================================== */
        :root {
            --azul-eletrico: #00aaff;
            --azul-fundo-escuro: #0d1a2e;
            --azul-fundo-medio: #1a293f;
            --cinza-texto-claro: #cdd5e0;
            --cinza-texto-medio: #a0aec0;
            --branco: #ffffff;
            --verde-sucesso: #28a745;
            --vermelho-erro: #e53e3e;
            --sombra-brilhante: 0 0 25px rgba(0, 170, 255, 0.2);
            --radius-padrao: 12px;
            --radius-card: 20px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--azul-fundo-escuro);
            color: var(--cinza-texto-claro);
            padding: 40px 20px;
            position: relative;
        }

        .background-glow {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at 50% 50%, rgba(0, 170, 255, 0.1), transparent 40%);
            pointer-events: none; z-index: -1;
            transition: transform 0.2s ease-out;
        }
        
        /* ===================================================================
           2. Estrutura Principal
           =================================================================== */
        .page-container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: var(--azul-fundo-medio);
            padding: 40px;
            border-radius: var(--radius-card);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 170, 255, 0.2);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(205, 213, 224, 0.1);
            padding-bottom: 25px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            color: var(--branco);
            font-size: 2rem;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* ===================================================================
           3. Botões
           =================================================================== */
        .btn {
            padding: 12px 25px; border: none;
            border-radius: 50px; font-weight: 600;
            font-size: 0.95rem; cursor: pointer;
            transition: all 0.3s ease; text-decoration: none;
            text-align: center; display: inline-block;
        }
        
        .cta-button {
            background: var(--azul-eletrico);
            color: var(--branco);
            box-shadow: var(--sombra-brilhante);
        }
        .cta-button:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 0 35px rgba(0, 170, 255, 0.5);
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--cinza-texto-medio);
            border: 1px solid var(--cinza-texto-medio);
        }
        .btn-secondary:hover {
            background-color: var(--azul-eletrico);
            border-color: var(--azul-eletrico);
            color: var(--branco);
            transform: translateY(-3px);
        }

        .btn-danger {
            background-color: var(--vermelho-erro);
            color: var(--branco);
            border: 1px solid var(--vermelho-erro);
        }
        .btn-danger:hover {
            background-color: #c53030;
            border-color: #c53030;
            transform: translateY(-2px);
        }
        
        /* ===================================================================
           4. Tabela de Dados e Indicadores
           =================================================================== */
        .tabela-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid rgba(205, 213, 224, 0.1); }
        
        th {
            background-color: var(--azul-fundo-escuro);
            color: var(--branco);
            font-weight: 600;
            font-size: 1rem;
        }
        
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(255, 255, 255, 0.03); }

        .btn-acao.excluir {
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            border-radius: var(--radius-padrao);
            background-color: var(--vermelho-erro);
            color: white; padding: 8px 14px;
            font-size: 0.85rem;
            transition: transform 0.2s ease;
        }
        .btn-acao.excluir:hover { transform: scale(1.1); }

        .estoque-baixo {
            background-color: var(--vermelho-erro);
            color: var(--branco);
            padding: 4px 10px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        /* ===================================================================
           5. Mensagens e Estados
           =================================================================== */
        .sem-dados { text-align: center; padding: 50px; font-weight: 500; color: var(--cinza-texto-medio); font-size: 1.1rem; }
        .hidden { display: none; }
        .text-danger { color: var(--vermelho-erro); font-style: italic; }

        .msg-feedback {
            position: fixed; top: 25px; right: 25px;
            color: var(--branco); padding: 16px 22px;
            border-radius: var(--radius-padrao);
            background-color: var(--azul-fundo-medio);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            font-weight: 500; z-index: 2100;
            opacity: 0; transform: translateY(-20px);
            pointer-events: none; transition: all 0.3s ease;
            border-left: 5px solid;
        }
        .msg-feedback.show { opacity: 1; transform: translateY(0); }
        .msg-feedback.success { border-color: var(--verde-sucesso); }
        
        /* ===================================================================
           6. Modal de Confirmação
           =================================================================== */
        .modal-backdrop {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.show { opacity: 1; pointer-events: all; }

        .modal-dialogo {
            background-color: var(--azul-fundo-medio);
            padding: 40px;
            border-radius: var(--radius-card);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 170, 255, 0.2);
            width: 90%; max-width: 500px;
            text-align: center;
            transform: scale(0.95) translateY(-10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-backdrop.show .modal-dialogo { transform: scale(1) translateY(0); }

        .modal-dialogo h2 {
            color: var(--branco); font-weight: 600;
            font-size: 1.5rem; margin-bottom: 15px;
        }
        .modal-dialogo p {
            color: var(--cinza-texto-claro);
            margin-bottom: 30px; line-height: 1.6;
        }
        .modal-dialogo p strong { color: var(--azul-eletrico); font-weight: 600; }
        .modal-actions { display: flex; justify-content: center; gap: 20px; }
    </style>
</head>
<body>
    <div class="background-glow"></div>

    <main class="page-container">
        <header>
            <h1>Histórico de Saídas</h1>
            <div class="header-actions">
                <a href="index.html" class="btn btn-secondary">← Voltar ao Dashboard</a>
                <a href="saida_pecas.html" class="btn cta-button">Registrar Nova Saída</a>
            </div>
        </header>

        <div id="tabela-container" class="tabela-wrapper hidden">
            <table id="tabelaSaidas">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Peça</th>
                        <th>Quantidade</th>
                        <th>Estoque Restante</th>
                        <th width="100px">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="semDadosMsg" class="sem-dados hidden">
            <p>Nenhuma saída de peça registrada. Clique em "Registrar Nova Saída" para começar.</p>
        </div>
    </main>

    <div id="feedback" class="msg-feedback"></div>

    <div id="modalConfirmacao" class="modal-backdrop">
        <div class="modal-dialogo">
            <h2>Confirmar Exclusão</h2>
            <p>Tem certeza que deseja excluir <strong id="itemParaExcluir"></strong>? Esta ação não pode ser desfeita.</p>
            <div class="modal-actions">
                <button id="btnCancelarExclusao" class="btn btn-secondary">Cancelar</button>
                <button id="btnConfirmarExclusao" class="btn btn-danger">Confirmar Exclusão</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ELEMENTOS DA PÁGINA
        const glow = document.querySelector('.background-glow');
        const ESTOQUE_MINIMO = 200;
        const tabelaContainer = document.getElementById('tabela-container');
        const tabelaBody = document.querySelector('#tabelaSaidas tbody');
        const semDadosMsg = document.getElementById('semDadosMsg');
        const feedbackDiv = document.getElementById('feedback');
        
        // ELEMENTOS DO MODAL
        const modalConfirmacao = document.getElementById('modalConfirmacao');
        const btnConfirmarExclusao = document.getElementById('btnConfirmarExclusao');
        const btnCancelarExclusao = document.getElementById('btnCancelarExclusao');
        const itemParaExcluir = document.getElementById('itemParaExcluir');
        
        let acaoConfirmada = null;

        if (glow) {
            document.body.addEventListener('mousemove', (e) => {
                const { clientX, clientY } = e;
                glow.style.background = `radial-gradient(circle at ${clientX}px ${clientY}px, rgba(0, 170, 255, 0.1), transparent 40%)`;
            });
        }
        
        // FUNÇÕES UTILITÁRIAS
        const mostrarFeedback = (mensagem, tipo = 'success') => {
            feedbackDiv.textContent = mensagem;
            feedbackDiv.className = `msg-feedback ${tipo} show`;
            setTimeout(() => { feedbackDiv.classList.remove('show'); }, 3000);
        };
        const getData = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const setData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const formatarData = (dataString) => {
            if (!dataString) return '---';
            const [ano, mes, dia] = dataString.split('-');
            return `${dia}/${mes}/${ano}`;
        };

        // LÓGICA DO MODAL
        const abrirModalConfirmacao = (nomeItem, onConfirm) => {
            itemParaExcluir.innerHTML = `<strong>${nomeItem}</strong>`;
            acaoConfirmada = onConfirm;
            modalConfirmacao.classList.add('show');
        };
        const fecharModalConfirmacao = () => {
            modalConfirmacao.classList.remove('show');
            acaoConfirmada = null;
        };
        btnConfirmarExclusao.addEventListener('click', () => {
            if (typeof acaoConfirmada === 'function') acaoConfirmada();
            fecharModalConfirmacao();
        });
        btnCancelarExclusao.addEventListener('click', fecharModalConfirmacao);
        modalConfirmacao.addEventListener('click', (event) => {
            if (event.target === modalConfirmacao) fecharModalConfirmacao();
        });


        // LÓGICA DA PÁGINA
        const handleExcluirSaida = (id) => {
            const executarExclusao = () => {
                const saidas = getData('saidasPecas');
                const saidasAtualizadas = saidas.filter(saida => saida.id !== id);
                setData('saidasPecas', saidasAtualizadas);
                
                mostrarFeedback('Registro de saída excluído com sucesso!');
                renderizarTabela();
            };
            
            abrirModalConfirmacao("este registro de saída", executarExclusao);
        };

        const renderizarTabela = () => {
            const pecas = getData('cadastrosGerais');
            const entradas = getData('entradasPecas');
            const saidas = getData('saidasPecas');
            
            const pecasMap = new Map(pecas.map(p => [p.id, { ...p }]));
            const estoquesMap = new Map();

            pecas.forEach(p => estoquesMap.set(p.id, Number(p.estoqueInicial) || 0));
            entradas.forEach(e => estoquesMap.set(e.pecaId, (estoquesMap.get(e.pecaId) || 0) + Number(e.quantidade)));
            saidas.forEach(s => estoquesMap.set(s.pecaId, (estoquesMap.get(s.pecaId) || 0) - Number(s.quantidade)));

            tabelaBody.innerHTML = '';
            
            if (saidas.length === 0) {
                tabelaContainer.classList.add('hidden');
                semDadosMsg.classList.remove('hidden');
                return;
            }
            
            const linhasHtml = saidas
                .sort((a, b) => new Date(b.dataSaida) - new Date(a.dataSaida))
                .map(saida => {
                    const peca = pecasMap.get(saida.pecaId);
                    const estoqueAtual = estoquesMap.get(saida.pecaId) ?? 'N/A';
                    const nomePeca = peca ? peca.nome : `<span class="text-danger">[Peça Apagada]</span>`;
                    const estoqueHtml = estoqueAtual < ESTOQUE_MINIMO
                        ? `<span class="estoque-baixo">${estoqueAtual}</span>`
                        : estoqueAtual;

                    return `
                        <tr>
                            <td>${formatarData(saida.dataSaida)}</td>
                            <td>${nomePeca}</td>
                            <td>${saida.quantidade}</td>
                            <td>${estoqueHtml}</td>
                            <td>
                                <button class="btn btn-acao excluir" data-id="${saida.id}">Excluir</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            
            tabelaBody.innerHTML = linhasHtml;
            tabelaContainer.classList.remove('hidden');
            semDadosMsg.classList.add('hidden');
        };

        tabelaBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('excluir')) {
                const id = event.target.dataset.id;
                handleExcluirSaida(id);
            }
        });

        renderizarTabela();
    });
    </script>
</body>
</html>